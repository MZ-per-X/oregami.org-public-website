---
layout: post
title: Flotter Dreier mit Jenkins, Git und Tomcat
date: '2012-08-08T23:02:00.001+02:00'
author: Sebastian Eichholz
tags:
- Programmierung
modified_time: '2013-01-07T08:04:25.822+01:00'
blogger_id: tag:blogger.com,1999:blog-4021402902609986484.post-5783422085332780887
blogger_orig_url: http://oregami-de.blogspot.com/2012/08/flotter-dreier-mit-jenkins-git-und.html
---

Das Ziel war klar: Unser <a href="https://github.com/oregami/oregami.org" target="_blank">Java-Programmcode</a> soll von unserem Jenkins-Build-Server regelmäßig kompiliert und dann auf unseren Tomcat-Server deployt werden. So weit, so gut. Doch dafür mussten einige Hindernisse überwunden werden.

In Bezug auf Versionierungs-Systeme hatte ich in meiner Programmierer-Vergangenheit bislang hauptsächlich Kontakt mit CVS und Subversion. Beide sind heute nicht mehr zeitgemäß, also wird unser Programmcode mit <a href="http://git-scm.com/" target="_blank">Git</a> verwaltet. Als Hoster habe ich <a href="https://github.com/" target="_blank">Github</a> ausgewählt, so <a href="https://github.com/popular/starred" target="_blank">viele bekannte Projekte</a> können da nicht falsch liegen.<br /><br />Zudem bin ich es beruflich mittlerweile gewohnt, dass der Programmcode mindestens einmal am Tag "gebaut" wird, der Griff zum <a href="http://jenkins-ci.org/" target="_blank">Jenkins-Buildserver</a> lag da sehr nah. Und der Tomcat-Server für unsere Java-Webanwendung sollte da leicht angebunden werden können - dachte ich zumindest.<!--more-->

Also, <b>Schritt 1</b>: <a href="https://wiki.jenkins-ci.org/display/JENKINS/Git+Plugin" target="_blank">Git-Plugin</a> für Jenkins installieren. Klappt problemlos. <br /><br /><b>Schritt 2</b>: Einen Git-Job im Jenkins erstellen, der den Programmcode aus <a href="https://github.com/oregami/oregami.org" target="_blank">unserem Repository</a> bei Github auscheckt. Leider klappt das nicht ganz problemlos, als eines der Probleme erweist sich die Authentifizierung bei Github - wobei ich dachte, dass man über die korrekte URL auch "anonym" auschecken kann. Ist aber wohl nicht so, zumindest über http(s) und ssh. Die als "read only" angepriesene URL git://github.com/oregami/oregami.org.git klappt leider nicht, vermutlich wegen der Firewall auf meinem Server. Die will ich aber lieber nicht anfassen.<br />Die Lösung für dieses Problem: Der Tomcat-User, unter dem Tomcat auch läuft, bekommt über ssh-keygen ein eigenes private/public-Key-Paar, und der Puclic Key wird bei Github hinterlegt. Dann noch über "git config" die EMail-Adresse und den Github-Usernamen hinterlegen, und es müsste klappen. Pustekuchen. Letzter Schritt vor dem Zwischenziel: einmal "git clone" in der Konsole aufrufen und den SSH-Server zu den "known-hosts" hinzufügen lassen. Erst jetzt klappt der Git-Checkout im Build-Job!<br /><br /><b>Schritt 3</b>: Jenkins soll per Maven den Java-Programmcode kompilieren. Eigentlich auch einfach. Aber auch hier liegt der Teufel im Detail: Der Programmcode liegt innerhalb des Repositories in einem <a href="https://github.com/oregami/oregami.org/tree/master/java" target="_blank">Unterverzeichnis</a>. Man hat ja auch noch was Anderes im Repository außer Programmcode... Das ist für das Git-Plugin anscheinend ein Problem. Diverse <a href="https://www.google.de/search?q=git+jenkins+source+subfolde" target="_blank">Google-Suchen</a> bringen kein hilfreiches Ergebnis. Letzendlich habe ich mich für die Notlösung entschieden: Im Hauptverzeichnis des Repositories wird eine neue pom.xml-Datei angelegt, die auf ein Modul mit dem Namen des Unterverzeichnisses verweist. Kleiner Missbrauch von Maven-Technologien, aber es funktioniert. Der Build läuft und gibt endlich (u.a.) das hier aus:<br />
<pre>[INFO] Building Oregami Webapp<br />[INFO]    task-segment: [clean, install]</pre>
<br />Aus dem Build purzelt eine WAR-Datei, die soll nun im letzten <b>Schritt 4</b> noch auf den laufenden Tomcat-Server deployt werden. Also her mit dem <a href="https://wiki.jenkins-ci.org/display/JENKINS/Deploy+Plugin" target="_blank">Jenkins-Deploy-Plugin</a>. Aber auch hier ist das, was ich als selbstverständlich erwartet hatte, nicht so einfach möglich: Wie sich nach weiteren Google-Recherchen herausstellt, haben sich mit Tomcat 7 die URLs für die Manager-Anwendung geändert, wodurch das Deployen fehlschlägt. Angeblich ist das <a href="https://issues.jenkins-ci.org/browse/JENKINS-8551" target="_blank">gefixt</a>, das scheint aber meiner installierten Version (die neueste) nicht zu interessieren. Glücklicherweise finde ich <a href="http://stackoverflow.com/questions/9277223/jenkins-auto-deploy-tomcat-7" target="_blank">hier</a> eine alternative Lösung, auch wenn sie keinen Schönheitspreis gewinnt: anstelle des Deploy-Plugins einfach einen Shell-Befehl mit "curl" ausführen, der die WAR-Datei an die entsprechende Tomcat-URL sendet. Was mir noch fehlte, war die Authentifizierung des curl-Aufrufs, dafür braucht man in der Datei tomcat-users.xml eine Rolle "manager-script". Auch das ist neu erst seit Tomcat Version 7. Keine Langeweile.<br /><br />Zu guter letzt noch herausfinden, wie man beim curl-Aufruf die übergebene User/Passwort-Kombination unsichtbar macht: nämlich indem man diese mit der Option "-K" aus einer Textdatei ausliest. Super! Das Ergebnis ist dann dieser Befehl:<br /><span style="font-family: &quot;Courier New&quot;, Courier, monospace;">curl -K /opt/tomcat/.tomcat_curl_user -T - 'http://demo.oregami.org/manager/text/deploy?update=true&amp;path=/' &lt; /opt/jenkins/jobs/oregami-git/workspace/java/target/web.war</span><br /><br />Und die Moral von der Geschicht':<br />Nach dem Prinzip der <a href="http://en.wikipedia.org/wiki/Continuous_integration" target="_blank">Continuous Integration</a> sollten die Entwickler oft ihre Programmänderungen committen und es sollten oft Anwendungs-Builds erfolgen. Das haben wir für unsere neue Online-Spiele-Datenbank <a href="http://www.oregami.org/" target="_blank">Oregami</a> nun hinbekommen. Zumindest das regelmäßige Bauen der Anwendung läuft, für mehr Commits brauchen wir <b>mehr Java-Programmierer</b> :-)<br /><br />Also: Steigt mit ein und schreibt eine Mail an sebastian[at]oregami.org !
