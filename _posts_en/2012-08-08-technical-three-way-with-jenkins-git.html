---
layout: post
title: Technical three-way with Jenkins, Git and Tomcat
date: '2012-08-08T23:20:00.000+02:00'
author: Sebastian Eichholz
tags:
- Development
modified_time: '2013-01-07T08:05:28.915+01:00'
blogger_id: tag:blogger.com,1999:blog-337622940517465099.post-7608848546192259278
blogger_orig_url: http://oregami-en.blogspot.com/2012/08/technical-three-way-with-jenkins-git.html
---

The goal was clear: Our <a href="https://github.com/oregami/oregami.org" target="_blank">Java code</a> shall be regularly compiled by a  Jenkins build server, then deployed to our Tomcat server. So far, so  good. But implementing this automatic workflow saw quite some obstacles  to jump over.<br /><br />When it comes to code versioning my personal programming past  mainly brought me close to CVS and Subversion, but both don't really  hold up any more today, so I decided to use <a href="http://git-scm.com/" target="_blank">git</a> for source code  maintenance. And because so <a href="https://github.com/popular/starred" target="_blank">many famous projects</a> cannot be wrong, I  chose <a href="https://github.com/" target="_blank">Github</a> as our online hosting service for this.<br /><br />For professional  reasons I am used to my program code being built at least once a day, so  the <a href="http://jenkins-ci.org/" target="_blank">Jenkins build server</a> was an obvious choice. And a Tomcat server for  our Java web service should be an easy target to deploy to, or so I  thought.<br /><br /><!--more-->Well, <b>step 1:</b> install <a href="https://wiki.jenkins-ci.org/display/JENKINS/Git+Plugin" target="_blank">git plugin</a> for Jenkins.  <br />No problems here.<br /><br /><b>Step 2:</b> create a git job in Jenkins which checks out our code from the <a href="https://github.com/oregami/oregami.org" target="_blank">Github repository</a>.  <br />This step, unfortunately, was the first with problems. The thing  was authentication with Github, because I thought that it supports  "anonymous" check-out of the code when using the correct URL. Doesn't  seem to be that way, at least not via http(s) and ssh, because the URL  git://github.com/oregami/oregami.org.git (advertized as "read-only")  didn't work. This may well have been a problem with the firewall on my  own server, but I don't dare touching that stuff at all.<br /><br />The solution for this problem was the Tomcat user, under which  Tomcat is actually running, receiving his/her own couple of  private/public key using ssh-keygen. The public key was then lodged at  Github, the email address and Github user name configured via "git  config" - and it should have worked. Fat chance, no chance! One last  step to go before this stopover: Call "git clone" once within the shell  and have the SSH server added to the "known hosts". And finally, the git  checkout was working within my build job!<br /><br /><b>Step 3:</b> let Jenkins compile our source code via Maven. Another one of those "simple" things. But the devil was in the  details in here, too: the program code was located in a <a href="https://github.com/oregami/oregami.org/tree/master/java" target="_blank">subdirectory</a>  within the repository, cause there's also other things in there beside  the code. Obviously, that seemed to be a problem for Jenkins' git  plugin. Browsing various <a href="https://www.google.de/search?q=git+jenkins+source+subfolde" target="_blank">Google searches</a> didn't bring up a helpful  result, so I finally went for a quite-less-than-ideal solution: I  created a new pom.xml file within the root of the repository which  pointed to a module named after the subdirectory. Little abuse of  Maven's technology, but it worked. At long last, the build runs and  displays, among other things, this here:<br /><pre>[INFO] Building Oregami Webapp<br />[INFO]    task-segment: [clean, install] </pre><br /><b>Step 4:</b> deploy the WAR file from the build to our Tomcat server. Give the <a href="https://wiki.jenkins-ci.org/display/JENKINS/Deploy+Plugin" target="_blank">Jenkins deploy plugin</a> to me! But this was another case  where the most natural things are not so natural at all. Deploy failed,  and after another round of Google research I concluded that with Tomcat 7  the URLs for the managing tool had changed. They said it was <a href="https://issues.jenkins-ci.org/browse/JENKINS-8551" target="_blank">fixed</a>, but  the Tomcat version I had installed (the latest) didn't seem to care  about this fix. Luckily I was also able to find an alternative <a href="http://stackoverflow.com/questions/9277223/jenkins-auto-deploy-tomcat-7" target="_blank">solution</a>  for this problem even when it won't win a beauty contest: instead of  using the deploy plugin I executed a shell command "curl" which simply  sends the WAR file to the respective Tomcat URL. The last thing missing  was authentication of the "curl" command which is what you need a role  called "manager-script" within the file tomcat-users.xml for. Another  new thing in version 7 of Tomcat, not a boring software to use, I guess. <br />And the most final thing to do was finding out how to hide the  transmitted user/password combination when "curling": parse it from a  text file using the option "-K". Brilliant! The result of all this is  the following command: <br /><span style="font-family: &quot;Courier New&quot;, Courier, monospace;">curl -K  /opt/tomcat/.tomcat_curl_user -T -  'http://demo.oregami.org/manager/text/deploy?update=true&amp;path=/'  &lt; /opt/jenkins/jobs/oregami-git/workspace/java/target/web.war</span><br /><br />And what's the end of this story? <br />Following the principle of <a href="http://en.wikipedia.org/wiki/Continuous_integration" target="_blank">continuous integration</a>, programmers  should regularly commit their changes, and there should be regular  builds of the software. That's what was achieved for our brand new  online games database <a href="http://www.oregami.org/" target="_blank">Oregami</a>. At least the regular builds are running,  more hackers are needed for more commits. :-)<br /><br />So join the club and write a mail to sebastian[at]oregami.org !
